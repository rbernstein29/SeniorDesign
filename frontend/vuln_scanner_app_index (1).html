<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VulnScanner · App</title>
<style>
  :root{
    --bg:#0b0d12;--panel:#11151b;--muted:#1a2029;--text:#e7eaee;--sub:#93a0b4;--brand:#5b8cff;--good:#2ecc71;--warn:#f1c40f;--bad:#ff5b6e;--border:#222937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, rgba(91,140,255,.18), transparent),radial-gradient(1000px 700px at 100% 0, rgba(106,247,255,.08), transparent), var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:#9db7ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
  .side{background:var(--panel);border-right:1px solid var(--border);padding:16px;display:flex;flex-direction:column;gap:12px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#8a6bff)}
  .brand{display:flex;gap:12px;align-items:center}
  .brand h1{margin:0;font-size:18px}
  .sub{color:var(--sub);font-size:12px}
  .nav{margin-top:8px;display:grid;gap:6px}
  .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--text);border:1px solid transparent}
  .nav a.active{background:var(--muted);border-color:var(--border)}
  .nav a:hover{background:#0f1420}
  .main{padding:22px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;align-items:center}
  .right{margin-left:auto}
  .btn{border:1px solid var(--border);background:var(--brand);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.secondary{background:var(--muted);color:var(--text)}
  .btn.ghost{background:transparent}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .field{display:grid;gap:6px}
  .label{text-transform:uppercase;letter-spacing:.08em;font-size:11px;color:var(--sub)}
  .input, select, textarea{background:#0f1420;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px}
  .grid{display:grid;gap:14px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3, 1fr)}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0f1420}
  .hint{color:var(--sub);font-size:12px}
  .banner{background:rgba(91,140,255,.08);border:1px solid rgba(91,140,255,.35);color:#cfe0ff;padding:10px;border-radius:12px;margin-bottom:14px}
  .banner.warn{background:rgba(241,196,15,.1);border-color:rgba(241,196,15,.4);color:#ffe9a6}
  .banner.bad{background:rgba(255,91,110,.09);border-color:rgba(255,91,110,.35);color:#ffccd2}
  .empty{border:1px dashed var(--border);padding:26px;border-radius:12px;text-align:center;color:var(--sub)}
  .code{font:13px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0f1420;border:1px solid var(--border);border-radius:10px;padding:12px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="app">
  <aside class="side">
    <div class="brand"><div class="logo"></div><div><h1>VulnScanner</h1><div class="sub" id="whoami">Loading…</div></div></div>
    <nav class="nav" id="nav"></nav>
    <div class="sub">Build: demo · Data stored locally</div>
  </aside>
  <main class="main">
    <div id="route"></div>
  </main>
</div>

<script>
// ===== Storage Keys (shared with login page) =====
const DB_KEY = 'vuln_users';
const AUTH_KEY = 'vuln_auth_user';
const SCAN_KEY = 'vuln_scans';

function loadUsers(){ return JSON.parse(localStorage.getItem(DB_KEY)||'[]'); }
function saveUsers(xs){ localStorage.setItem(DB_KEY, JSON.stringify(xs)); }
function findUser(email){ return loadUsers().find(u=>u.email.toLowerCase()===email.toLowerCase()); }
function setAuthed(user){ localStorage.setItem(AUTH_KEY, JSON.stringify({ email:user.email, role:user.role||'Admin' })); }
function getAuthed(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)||'null'); }catch{return null;} }

function loadScans(){ return JSON.parse(localStorage.getItem(SCAN_KEY)||'[]'); }
function saveScans(xs){ localStorage.setItem(SCAN_KEY, JSON.stringify(xs)); }

// ===== Demo Seed =====
(function seed(){
  // Seed scans
  const scans = loadScans();
  if(scans.length===0){
    const now = Date.now();
    const sample = [
      { id: crypto.randomUUID(), target:"10.0.0.12", name:"Weekly webapp", status:"Complete", startedAt: now-86400000*3, durationSec: 412, findings:[
        { id:"WEB-001", severity:"High", title:"SQL Injection", cwe:89, path:"/api/login", evidence:"payload '..'", recommendation:"Use prepared statements" },
        { id:"WEB-017", severity:"Medium", title:"Outdated jQuery", cwe:null, path:"/static/js/jquery-1.12.4.js", evidence:"1.12.4", recommendation:"Upgrade to 3.x" }
      ], meta:{ engine:"v0.9.2", profile:"Full", options:{ auth:"form", depth:2 } } },
      { id: crypto.randomUUID(), target:"prod.example.com", name:"Nightly surface sweep", status:"Running", startedAt: now-120000, durationSec: 120, findings:[], meta:{ engine:"v0.9.2", profile:"Light", options:{ threads:8 } } }
    ];
    saveScans(sample);
  }
})();

// ===== Simple Router =====
const routes = {
  dashboard: renderDashboard,
  reports: renderReports,
  accounts: renderAccounts,
  settings: renderSettings,
};

const NAV_ITEMS = [
  { id:'dashboard', label:'Dashboard' },
  { id:'reports', label:'Reports' },
  { id:'accounts', label:'Accounts' },
  { id:'settings', label:'Settings' },
];

function navTo(id){
  window.location.hash = id;
}

function initNav(){
  const nav = document.getElementById('nav');
  nav.innerHTML = '';
  NAV_ITEMS.forEach(it=>{
    const a=document.createElement('a');
    a.href = `#${it.id}`; a.textContent = it.label; a.dataset.id = it.id;
    a.onclick = (e)=>{ e.preventDefault(); navTo(it.id); };
    nav.appendChild(a);
  });
}

function setActive(id){
  document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.id===id));
}

function mount(routeId){
  if(!(routeId in routes)) routeId = 'dashboard';
  setActive(routeId);
  const el = document.getElementById('route');
  el.innerHTML = '';
  routes[routeId](el);
}

window.addEventListener('hashchange', ()=>mount(location.hash.replace('#','')||'dashboard'));

// ===== Role helpers (Read-Only support) =====
function isReadOnly(){
  const u = getAuthed();
  return (u && (u.role === 'Viewer' || u.role === 'ReadOnly'));
}

function guardDisabled(btn){
  if(isReadOnly()) btn.setAttribute('disabled','');
}

function guardBanner(parent){
  if(isReadOnly()){
    const b = document.createElement('div');
    b.className='banner warn';
    b.textContent='Read‑only mode: you can view data but cannot modify settings, users, or run scans.';
    parent.prepend(b);
  }
}

// ===== Views =====
function renderDashboard(root){
  const u = getAuthed();
  root.innerHTML = `
    <div class="panel">
      <div class="row">
        <h2 style="margin:0">Welcome${u?`, ${u.email}`:''}</h2>
        <span class="pill right">Role: ${u?u.role:'Unknown'}</span>
      </div>
      <p class="sub">Quick overview of recent scans and findings.</p>
    </div>
    <div style="height:12px"></div>
    <div class="grid cols-2">
      <div class="panel" id="card-scans"></div>
      <div class="panel" id="card-findings"></div>
    </div>
  `;
  guardBanner(root);
  const scans = loadScans();
  const recent = scans.sort((a,b)=>b.startedAt-a.startedAt).slice(0,5);
  document.getElementById('card-scans').innerHTML = `
    <div class="row"><h3 style="margin:0">Recent scans</h3><a class="right" href="#reports">View all</a></div>
    ${recent.length?`<table class="tbl"><thead><tr><th>Name</th><th>Target</th><th>Status</th><th>Started</th></tr></thead><tbody>
      ${recent.map(s=>`<tr><td>${s.name}</td><td>${s.target}</td><td>${s.status}</td><td>${new Date(s.startedAt).toLocaleString()}</td></tr>`).join('')}
    </tbody></table>`: `<div class="empty">No scans yet.</div>`}
  `;

  const allFindings = scans.flatMap(s=>s.findings.map(f=>({ ...f, scan:s.name })));
  document.getElementById('card-findings').innerHTML = `
    <div class="row"><h3 style="margin:0">Latest findings</h3></div>
    ${allFindings.length?`<table class="tbl"><thead><tr><th>Severity</th><th>Title</th><th>Scan</th><th>Location</th></tr></thead><tbody>
      ${allFindings.slice(0,8).map(f=>`<tr><td><span class="pill">${f.severity}</span></td><td>${f.title}</td><td>${f.scan}</td><td>${f.path||'-'}</td></tr>`).join('')}
    </tbody></table>`: `<div class="empty">No findings yet.</div>`}
  `;
}

// ===== Reports (with JSON download) =====
function renderReports(root){
  const scans = loadScans();
  root.innerHTML = `
    <div class="panel">
      <div class="row"><h2 style="margin:0">Reports</h2><span class="hint right">Export full JSON for any scan</span></div>
      ${scans.length?`<table class="tbl"><thead><tr><th>Scan</th><th>Target</th><th>Status</th><th>Findings</th><th></th></tr></thead><tbody>
        ${scans.map(s=>`<tr>
          <td>${s.name}</td>
          <td>${s.target}</td>
          <td>${s.status}</td>
          <td>${s.findings.length}</td>
          <td class="row">
            <button class="btn secondary" data-view="${s.id}">View</button>
            <button class="btn" data-dl="${s.id}">Download JSON</button>
          </td>
        </tr>`).join('')}
      </tbody></table>` : `<div class="empty">No reports yet.</div>`}
    </div>
    <div style="height:12px"></div>
    <div class="panel" id="report-detail"><div class="hint">Select a scan to view its details.</div></div>
  `;
  guardBanner(root);

  // wire buttons
  root.querySelectorAll('[data-dl]').forEach(btn=>{
    const id = btn.getAttribute('data-dl');
    btn.onclick = ()=>downloadScanJSON(id);
  });
  root.querySelectorAll('[data-view]').forEach(btn=>{
    const id = btn.getAttribute('data-view');
    btn.onclick = ()=>showScanDetail(id);
  });
}

function downloadScanJSON(id){
  const scan = loadScans().find(x=>x.id===id);
  if(!scan) return;
  const data = JSON.stringify(scan, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${slug(scan.name)}-${scan.id}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  a.remove();
}

function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

function showScanDetail(id){
  const scan = loadScans().find(x=>x.id===id);
  const box = document.getElementById('report-detail');
  if(!scan){ box.innerHTML = '<div class="empty">Scan not found.</div>'; return; }
  box.innerHTML = `
    <div class="row">
      <h3 style="margin:0">${scan.name}</h3>
      <span class="pill right">${scan.status}</span>
      <button class="btn" onclick="downloadScanJSON('${scan.id}')">Download JSON</button>
    </div>
    <div class="grid cols-3" style="margin-top:10px">
      <div class="field"><div class="label">Target</div><div>${scan.target}</div></div>
      <div class="field"><div class="label">Started</div><div>${new Date(scan.startedAt).toLocaleString()}</div></div>
      <div class="field"><div class="label">Duration</div><div>${scan.durationSec}s</div></div>
    </div>
    <div style="height:10px"></div>
    <div class="field"><div class="label">Engine / Profile</div><div>${scan.meta.engine} / ${scan.meta.profile}</div></div>
    <div class="field"><div class="label">Options</div><pre class="code">${JSON.stringify(scan.meta.options, null, 2)}</pre></div>
    <div class="field"><div class="label">Findings (${scan.findings.length})</div>
      ${scan.findings.length?`<table class="tbl"><thead><tr><th>Severity</th><th>Title</th><th>CWE</th><th>Path</th></tr></thead><tbody>
        ${scan.findings.map(f=>`<tr><td><span class="pill">${f.severity}</span></td><td>${f.title}</td><td>${f.cwe??'-'}</td><td>${f.path??'-'}</td></tr>`).join('')}
      </tbody></table>`:'<div class="empty">No findings for this scan.</div>'}
    </div>
  `;
}

// ===== Accounts (configure user roles incl. Read‑Only) =====
function renderAccounts(root){
  const me = getAuthed();
  const users = loadUsers();
  root.innerHTML = `
    <div class="panel">
      <div class="row"><h2 style="margin:0">Accounts</h2><span class="hint right">Set teammates as Admin or Read‑Only</span></div>
      ${users.length?`<table class="tbl"><thead><tr><th>Name</th><th>Email</th><th>Org</th><th>Role</th><th>Status</th><th></th></tr></thead><tbody>
        ${users.map(u=>`<tr>
          <td>${u.name||'-'}</td>
          <td>${u.email}</td>
          <td>${u.org||'-'}</td>
          <td>
            <select data-role="${u.email}">
              <option ${u.role==='Admin'? 'selected':''}>Admin</option>
              <option ${u.role==='Viewer'||u.role==='ReadOnly'? 'selected':''}>ReadOnly</option>
            </select>
          </td>
          <td>${u.verified?'<span class="pill">Verified</span>':'<span class="pill">Pending</span>'}</td>
          <td class="row">
            <button class="btn secondary" data-reset="${u.email}">Reset Password</button>
            <button class="btn bad" style="display:none" data-del="${u.email}">Remove</button>
          </td>
        </tr>`).join('')}
      </tbody></table>` : `<div class="empty">No users found.</div>`}
    </div>
  `;
  guardBanner(root);

  // Disable edits in read-only mode, and prevent lowering own role
  root.querySelectorAll('select[data-role]').forEach(sel=>{
    const email = sel.getAttribute('data-role');
    if(isReadOnly() || (me && me.email===email)) sel.setAttribute('disabled','');
    sel.onchange = ()=>{
      const users = loadUsers();
      const u = users.find(x=>x.email===email);
      if(u){ u.role = sel.value==='Admin' ? 'Admin' : 'ReadOnly'; saveUsers(users);
        if(me && me.email===u.email){ setAuthed(u); updateWhoAmI(); }
      }
    };
  });

  root.querySelectorAll('[data-reset]').forEach(btn=>{
    guardDisabled(btn);
    btn.onclick = ()=>{
      if(isReadOnly()) return;
      alert('Demo: password reset link sent to '+btn.getAttribute('data-reset'));
    };
  });
}

// ===== Settings (expanded) =====
function renderSettings(root){
  const cfg = loadSettings();
  root.innerHTML = `
    <div class="panel">
      <div class="row"><h2 style="margin:0">Settings</h2><span class="hint right">Preferences are stored in this browser</span></div>
      <div style="height:10px"></div>
      <div class="grid cols-2">
        <div class="field">
          <div class="label">Theme</div>
          <select id="set-theme">
            <option value="dark" ${cfg.theme==='dark'?'selected':''}>Dark (default)</option>
            <option value="light" ${cfg.theme==='light'?'selected':''}>Light</option>
            <option value="system" ${cfg.theme==='system'?'selected':''}>System</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Time format</div>
          <select id="set-timefmt">
            <option value="auto" ${cfg.timefmt==='auto'?'selected':''}>Auto</option>
            <option value="12h" ${cfg.timefmt==='12h'?'selected':''}>12‑hour</option>
            <option value="24h" ${cfg.timefmt==='24h'?'selected':''}>24‑hour</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Notifications</div>
          <label class="row"><input type="checkbox" id="set-email" ${cfg.email?'checked':''}/> <span>Email me when scans finish</span></label>
          <label class="row"><input type="checkbox" id="set-alerts" ${cfg.alerts?'checked':''}/> <span>Only alert on High/Critical</span></label>
        </div>
        <div class="field">
          <div class="label">Data retention</div>
          <select id="set-retain">
            <option value="7" ${cfg.retention==='7'?'selected':''}>7 days</option>
            <option value="30" ${cfg.retention==='30'?'selected':''}>30 days</option>
            <option value="90" ${cfg.retention==='90'?'selected':''}>90 days</option>
            <option value="forever" ${cfg.retention==='forever'?'selected':''}>Forever</option>
          </select>
          <div class="hint">Older scans will be auto‑deleted based on this policy (demo only).</div>
        </div>
        <div class="field">
          <div class="label">API token</div>
          <div class="row">
            <input class="input" id="set-token" value="${cfg.token}" readonly />
            <button class="btn" id="btn-reissue">Reissue</button>
          </div>
          <div class="hint">Use this token with CLI / CI integrations.</div>
        </div>
        <div class="field">
          <div class="label">Export / Import settings</div>
          <div class="row">
            <button class="btn secondary" id="btn-export">Export JSON</button>
            <input type="file" id="in-import" accept="application/json" style="display:none"/>
            <button class="btn" id="btn-import">Import JSON</button>
          </div>
        </div>
        <div class="field">
          <div class="label">Change password</div>
          <div class="grid cols-2">
            <input class="input" type="password" id="pw1" placeholder="New password" />
            <input class="input" type="password" id="pw2" placeholder="Confirm password" />
          </div>
          <div class="row" style="margin-top:8px"><button class="btn" id="btn-changepw">Update password</button></div>
        </div>
      </div>
    </div>
  `;
  guardBanner(root);

  // wiring
  const byId = id=>root.querySelector('#'+id);
  guardDisabled(byId('btn-reissue'));
  guardDisabled(byId('btn-export'));
  guardDisabled(byId('btn-import'));
  guardDisabled(byId('btn-changepw'));

  byId('btn-reissue').onclick = ()=>{ if(isReadOnly()) return; cfg.token = genToken(); saveSettings(cfg); byId('set-token').value = cfg.token; };
  byId('btn-export').onclick = ()=>{ if(isReadOnly()) return; downloadJSON('vuln-settings.json', cfg); };
  byId('btn-import').onclick = ()=>{ if(isReadOnly()) return; byId('in-import').click(); };
  byId('in-import').onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ try{ const obj = JSON.parse(r.result); saveSettings(obj); alert('Settings imported.'); mount('settings'); }catch{ alert('Invalid JSON.'); } };
    r.readAsText(f);
  };
  byId('btn-changepw').onclick = ()=>{
    if(isReadOnly()) return;
    const a = byId('pw1').value, b = byId('pw2').value; if(!a||a.length<8) return alert('Password must be at least 8 characters.');
    if(a!==b) return alert('Passwords do not match.');
    const me = getAuthed(); const xs = loadUsers(); const u = xs.find(x=>x.email===me.email); if(u){ u.pass=a; saveUsers(xs); alert('Password updated.'); byId('pw1').value = byId('pw2').value = ''; }
  };

  // simple selects save immediately
  ['set-theme','set-timefmt','set-retain'].forEach(id=>{
    const el = byId(id); el.onchange = ()=>{ cfg.theme = byId('set-theme').value; cfg.timefmt=byId('set-timefmt').value; cfg.retention=byId('set-retain').value; saveSettings(cfg); };
  });
  byId('set-email').onchange = e=>{ cfg.email = e.target.checked; saveSettings(cfg); };
  byId('set-alerts').onchange = e=>{ cfg.alerts = e.target.checked; saveSettings(cfg); };
}

// ===== Settings persistence =====
const SET_KEY = 'vuln_settings';
function loadSettings(){
  const def = { theme:'dark', timefmt:'auto', email:true, alerts:true, retention:'30', token: genToken() };
  try{ return Object.assign(def, JSON.parse(localStorage.getItem(SET_KEY)||'{}')); }catch{ return def; }
}
function saveSettings(obj){ localStorage.setItem(SET_KEY, JSON.stringify(obj)); }
function genToken(){ return [...crypto.getRandomValues(new Uint8Array(16))].map(x=>x.toString(16).padStart(2,'0')).join(''); }
function downloadJSON(name, obj){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 5000); a.remove(); }

// ===== Auth gate =====
function requireAuth(){
  // No‑signin demo mode: if no authed user, create a local demo Admin.
  let u = getAuthed();
  if(!u){
    const demo = { email:'demo@local', role:'Admin' };
    setAuthed(demo);
    u = demo;
  }
  document.getElementById('whoami').textContent = `${u.email} · ${u.role}`;
  return true;
}
function updateWhoAmI(){ const u=getAuthed(); if(u) document.getElementById('whoami').textContent = `${u.email} · ${u.role}`; }

// ===== Boot =====
initNav();
if(requireAuth()){
  mount(location.hash.replace('#','')||'dashboard');
}
</script>
</body>
</html>
